# WOIC System Integration Reference
**Purpose**: Defines integration points between Web App and Agent Server
**Status**: Production Operational
**Last Updated**: 2025-08-29

## 🏗️ System Architecture Overview

```
Web Application (woic.app)           Agent Server (woic-agent-server-production.up.railway.app)
├── Next.js Frontend                 ├── WebSocket Server  
├── Authentication UI                ├── Voice Processing Pipeline
├── Agent Management                 ├── STT → LLM → TTS
├── Knowledge Base UI                └── Session Management
└── Voice Interface Components
```

## 🔗 Integration Points

### 1. **WebSocket Connection**
```
Web App → wss://woic-agent-server-production.up.railway.app/agent
Protocol: WebSocket with JSON messages
Authentication: Session token via connection headers
Purpose: Real-time voice processing communication
```

### 2. **Authentication Flow**
```
Web App: JWT generation (Supabase Auth)
Agent Server: JWT validation (shared secret)
Integration: Bearer token in WebSocket headers
```

### 3. **Voice Configuration Sync**
```
Web App: Voice selection UI → WebSocket message
Agent Server: Receives voice config → Updates TTS settings
Message Type: 'voice_config_update'
```

### 4. **Session Management**
```
Web App: Session initiation → WebSocket connection
Agent Server: Session tracking → UUID-based sessions
Cleanup: Both systems coordinate session termination
```

## 📡 WebSocket Message Protocol

### Web App → Agent Server:
```typescript
// Session start
{ type: 'session.start', sessionId: string, turnId: string }

// Audio data
{ type: 'audio', data: ArrayBuffer }

// Voice configuration
{ type: 'voice_config', voiceId: string, settings: object }

// Session end
{ type: 'session.end', sessionId: string }
```

### Agent Server → Web App:
```typescript
// STT results
{ type: 'stt_partial', text: string, sessionId: string }
{ type: 'stt_final', text: string, sessionId: string }

// TTS audio
{ type: 'tts_chunk', audio: ArrayBuffer, sessionId: string }

// Errors
{ type: 'error', code: string, message: string }
```

## 🔑 Environment Variables Integration

### Web App (.env):
```
NEXT_PUBLIC_AGENT_WS_URL=wss://woic-agent-server-production.up.railway.app/agent
SESSION_JWT_SECRET=<shared-secret>
```

### Agent Server (.env):
```
ALLOWED_ORIGINS=https://woic.app,https://woic.realmonkey.ai
SESSION_JWT_SECRET=<shared-secret>
PORT=4010
```

## 🚨 Critical Dependencies

### Web App Dependencies on Agent Server:
- Voice processing functionality requires agent server
- WebSocket connection health affects UI voice controls
- Error handling depends on agent server error messages

### Agent Server Dependencies on Web App:
- Authentication tokens generated by web app
- Voice configuration parameters sent from web app UI
- Session management coordinated with web app

## 📊 Production Endpoints

### Web Application:
- **Primary**: https://woic.app
- **Secondary**: https://woic.realmonkey.ai
- **API**: https://woic.app/api/*

### Agent Server:
- **WebSocket**: wss://woic-agent-server-production.up.railway.app/agent
- **Health Check**: https://woic-agent-server-production.up.railway.app/healthz

## 🔄 Error Handling Integration

### Connection Failures:
```
Agent Server Down → Web App shows "Voice unavailable"
WebSocket Error → Web App auto-retry with exponential backoff
Authentication Failure → Web App redirects to login
```

### Voice Processing Errors:
```
STT Error → Agent server sends error message → Web App displays user-friendly message
TTS Error → Agent server fallback → Web App shows processing status
Session Timeout → Both systems cleanup → Web App resets voice UI
```

## 🎯 Integration Testing Checklist - ALL COMPLETED

- [✅] WebSocket connection establishment
- [✅] Authentication token validation
- [✅] Voice configuration synchronization
- [✅] Audio streaming (both directions)
- [✅] Error handling and recovery
- [✅] Session cleanup on disconnect
- [✅] CORS validation for production domains
- [✅] Complete STT → LLM → TTS pipeline operational
- [✅] User can hear AI voice responses in production

## ⚠️ Integration Rules for AI Assistants

### When Working on Web App:
- Voice functionality requires integration with agent server
- UI changes affecting voice must consider WebSocket protocol
- Authentication changes must maintain agent server compatibility

### When Working on Agent Server:
- WebSocket protocol changes must maintain web app compatibility
- Authentication changes must align with web app JWT generation
- Error messages must be user-friendly for web app display

### Cross-System Changes:
- Always document WebSocket message format changes
- Maintain backward compatibility for graceful deployments
- Test integration end-to-end before deployment

---

**Integration Status**: ✅ Production Operational
**Next Review**: When either system undergoes major changes
**Monitoring**: Both systems health checked independently