# WOIC System Integration Reference
**Purpose**: Defines integration points between Web App and Agent Server
**Status**: Production Operational
**Last Updated**: 2025-08-29

## ğŸ—ï¸ System Architecture Overview

```
Web Application (woic.app)           Agent Server (woic-agent-server-production.up.railway.app)
â”œâ”€â”€ Next.js Frontend                 â”œâ”€â”€ WebSocket Server  
â”œâ”€â”€ Authentication UI                â”œâ”€â”€ Voice Processing Pipeline
â”œâ”€â”€ Agent Management                 â”œâ”€â”€ STT â†’ LLM â†’ TTS
â”œâ”€â”€ Knowledge Base UI                â””â”€â”€ Session Management
â””â”€â”€ Voice Interface Components
```

## ğŸ”— Integration Points

### 1. **WebSocket Connection**
```
Web App â†’ wss://woic-agent-server-production.up.railway.app/agent
Protocol: WebSocket with JSON messages
Authentication: Session token via connection headers
Purpose: Real-time voice processing communication
```

### 2. **Authentication Flow**
```
Web App: JWT generation (Supabase Auth)
Agent Server: JWT validation (shared secret)
Integration: Bearer token in WebSocket headers
```

### 3. **Voice Configuration Sync**
```
Web App: Voice selection UI â†’ WebSocket message
Agent Server: Receives voice config â†’ Updates TTS settings
Message Type: 'voice_config_update'
```

### 4. **Session Management**
```
Web App: Session initiation â†’ WebSocket connection
Agent Server: Session tracking â†’ UUID-based sessions
Cleanup: Both systems coordinate session termination
```

## ğŸ“¡ WebSocket Message Protocol

### Web App â†’ Agent Server:
```typescript
// Session start
{ type: 'session.start', sessionId: string, turnId: string }

// Audio data
{ type: 'audio', data: ArrayBuffer }

// Voice configuration
{ type: 'voice_config', voiceId: string, settings: object }

// Session end
{ type: 'session.end', sessionId: string }
```

### Agent Server â†’ Web App:
```typescript
// STT results
{ type: 'stt_partial', text: string, sessionId: string }
{ type: 'stt_final', text: string, sessionId: string }

// TTS audio
{ type: 'tts_chunk', audio: ArrayBuffer, sessionId: string }

// Errors
{ type: 'error', code: string, message: string }
```

## ğŸ”‘ Environment Variables Integration

### Web App (.env):
```
NEXT_PUBLIC_AGENT_WS_URL=wss://woic-agent-server-production.up.railway.app/agent
SESSION_JWT_SECRET=<shared-secret>
```

### Agent Server (.env):
```
ALLOWED_ORIGINS=https://woic.app,https://woic.realmonkey.ai
SESSION_JWT_SECRET=<shared-secret>
PORT=4010
```

## ğŸš¨ Critical Dependencies

### Web App Dependencies on Agent Server:
- Voice processing functionality requires agent server
- WebSocket connection health affects UI voice controls
- Error handling depends on agent server error messages

### Agent Server Dependencies on Web App:
- Authentication tokens generated by web app
- Voice configuration parameters sent from web app UI
- Session management coordinated with web app

## ğŸ“Š Production Endpoints

### Web Application:
- **Primary**: https://woic.app
- **Secondary**: https://woic.realmonkey.ai
- **API**: https://woic.app/api/*

### Agent Server:
- **WebSocket**: wss://woic-agent-server-production.up.railway.app/agent
- **Health Check**: https://woic-agent-server-production.up.railway.app/healthz

## ğŸ”„ Error Handling Integration

### Connection Failures:
```
Agent Server Down â†’ Web App shows "Voice unavailable"
WebSocket Error â†’ Web App auto-retry with exponential backoff
Authentication Failure â†’ Web App redirects to login
```

### Voice Processing Errors:
```
STT Error â†’ Agent server sends error message â†’ Web App displays user-friendly message
TTS Error â†’ Agent server fallback â†’ Web App shows processing status
Session Timeout â†’ Both systems cleanup â†’ Web App resets voice UI
```

## ğŸ¯ Integration Testing Checklist - ALL COMPLETED

- [âœ…] WebSocket connection establishment
- [âœ…] Authentication token validation
- [âœ…] Voice configuration synchronization
- [âœ…] Audio streaming (both directions)
- [âœ…] Error handling and recovery
- [âœ…] Session cleanup on disconnect
- [âœ…] CORS validation for production domains
- [âœ…] Complete STT â†’ LLM â†’ TTS pipeline operational
- [âœ…] User can hear AI voice responses in production

## âš ï¸ Integration Rules for AI Assistants

### When Working on Web App:
- Voice functionality requires integration with agent server
- UI changes affecting voice must consider WebSocket protocol
- Authentication changes must maintain agent server compatibility

### When Working on Agent Server:
- WebSocket protocol changes must maintain web app compatibility
- Authentication changes must align with web app JWT generation
- Error messages must be user-friendly for web app display

### Cross-System Changes:
- Always document WebSocket message format changes
- Maintain backward compatibility for graceful deployments
- Test integration end-to-end before deployment

---

**Integration Status**: âœ… Production Operational
**Next Review**: When either system undergoes major changes
**Monitoring**: Both systems health checked independently